{% extends "base.html" %}
{% block title %}Rooms{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="card p-3">
        <h3 class="card-title mb-0">{{ room.room_name }}</h3>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card p-3 my-4" style="height: 65vh;">
                <div class="h-100 d-inline-block overflow-auto text-justify pr-2" id="chat-box">
                    {% for chat_message in chat_messages %}
                    <p class="font-weight-bold m-0">{{ chat_message.sender }}</p>
                    <p class="text-secondary m-0">{{ chat_message.message }}</p>
                    <hr class="my-1">
                    {% endfor %}
                </div>
            </div>
            
            <div class="card">
                <div class="input-group">
                    <input type="text" class="form-control" id="message-input" name="msg">
                    <div class="input-group-append">
                        <input class="btn btn-primary" id="message-send-input" value="Send">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 my-4 list-group" id="online-list" style="height: 65vh;">
                <h5>Online who joined this room:</h5>
                <hr class="my-1">
                {% for online_user in online_users %}
                <li class="list-group-item list-group-item-action">{{ online_user.user.username }}</li>
                {% endfor %}
            </div>
        </div>
    </div>

    
</div>
<script>
    var room_id = "{{ room.id|escapejs }}";
    var user_name = "{{ user|escapejs }}";
    var chat_box = document.querySelector('#chat-box');
    var online_list = document.querySelector('#online-list');
    chat_box.scrollTop = chat_box.scrollHeight;

    var ws_protocol = window.location.protocol == "https:" ? "wss" : "ws";
    var ws_path = ws_protocol + '://' + window.location.host + "/room/" + room_id + "/";
    var socket = new WebSocket(ws_path);

    socket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        if (data['type']=='message') {
            createMessageDOM(data['sender'], data['message']);
        } else if (data['type']=='user_joined') {
            userJoinedOrLeftDOM(data['user'] + " joined the room.")
            if (user_name != data['user']) {
                addList(data['user'])
            }
        } else {
            userJoinedOrLeftDOM(data['user'] + " left the room.")
            deleteList(data['user'])
        }
    };

    function addList(user) {
        var list = document.createElement('li');
        list.className = 'list-group-item list-group-item-action'
        list.appendChild(document.createTextNode(user))
        online_list.appendChild(list)
    }

    function deleteList(user) {
        lists = online_list.childNodes;
        for (var i = 0; i < lists.length; i++) {
            if (lists[i].innerHTML == user) {
                online_list.removeChild(lists[i]);
            }
        }
    }
    
    function userJoinedOrLeftDOM(msg) {
        var paragraph = document.createElement('p');
        paragraph.className = "text-center font-weight-light font-italic";
        paragraph.appendChild(document.createTextNode(msg));
        chat_box.appendChild(paragraph);

        chat_box.scrollTop = chat_box.scrollHeight;
    }

    function createMessageDOM(sender, message) {
        var paragraph = document.createElement('p');
        paragraph.className = 'font-weight-bold m-0';
        paragraph.appendChild(document.createTextNode(sender));
        chat_box.appendChild(paragraph);

        var message_paragraph = document.createElement('p');
        message_paragraph.className = 'text-secondary m-0';
        message_paragraph.appendChild(document.createTextNode(message));
        chat_box.appendChild(message_paragraph);

        var horizontal_bar = document.createElement('hr');
        horizontal_bar.className = 'my-1';
        chat_box.appendChild(horizontal_bar);

        chat_box.scrollTop = chat_box.scrollHeight;
    }


    socket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#message-input').focus();
    document.querySelector('#message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {
            document.querySelector('#message-send-input').click();
        }
    };

    document.querySelector('#message-send-input').onclick = function (e) {
        var messageInputDom = document.querySelector('#message-input');
        var message = messageInputDom.value;
        socket.send(JSON.stringify({
            'type' : 'message',
            'message': message
        }));

        messageInputDom.value = '';
    };
</script>
{% endblock %}